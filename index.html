<!DOCTYPE html>
<html>
<head>
    <title>Aberscene</title>
    <link rel='shortcut icon' type='image/png' href='favicon.png'>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <script defer src="https://use.fontawesome.com/releases/v5.0.8/js/all.js"></script>
    <script src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/bootstrap.daterangepicker/2/daterangepicker.js"></script>
    <script src="events.js"></script>

    <meta name="viewport" content="minimal-ui, width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <meta charset="utf-8">

    <link rel="stylesheet" type="text/css" href="style.css">
    <link rel="stylesheet" type="text/css" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/bootstrap.daterangepicker/2/daterangepicker.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">

    <script defer src="https://use.fontawesome.com/releases/v5.0.8/js/solid.js" integrity="sha384-+Ga2s7YBbhOD6nie0DzrZpJes+b2K1xkpKxTFFcx59QmVPaSA8c7pycsNaFwUK6l" crossorigin="anonymous"></script>
    <script defer src="https://use.fontawesome.com/releases/v5.0.8/js/fontawesome.js" integrity="sha384-7ox8Q2yzO/uWircfojVuCQOZl+ZZBg2D2J5nkpLqzH1HY0C1dHlTKIbpRz/LG23c" crossorigin="anonymous"></script>
</head>
<body>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyApTvTwhzrDL5KuyNJAukTGCkDE6hOudVI&callback=main" async defer></script>
<div class="navi">
    <nav id="navibar" class="navbar navbar-expand-xl navbar-light" style="background: rgba(255,255,255,0.9);">
        <a class="navbar-brand" href="#"><img src="logo.png" height="25px" style="margin-top:-4px;">ABER<strong>SCENE</strong></a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav mr-auto">
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><i class="fas fa-music"></i> <span></span>Entertainment</a>
                    <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                        <a class="dropdown-item" href="#">Music</a>
                        <a class="dropdown-item" href="#">Comedy</a>
                        <a class="dropdown-item" href="#">Cinema</a>
                        <a class="dropdown-item" href="#">Libraries</a>
                        <a class="dropdown-item" href="#">Kids and Family</a>
                        <a class="dropdown-item" href="#">Theme Parks</a>
                        <a class="dropdown-item" href="#">Nightlife</a>
                    </div>
                </li>

                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><i class="fas fa-utensils"></i> <span></span>Dining</a>
                    <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                        <a class="dropdown-item" href="#">Takeaway</a>
                        <a class="dropdown-item" href="#">Pubs</a>
                        <a class="dropdown-item" href="#">Cafes/Coffee shops</a>
                        <a class="dropdown-item" href="#">Indian</a>
                        <a class="dropdown-item" href="#">Chinese</a>
                        <a class="dropdown-item" href="#">Italian</a>
                    </div>
                </li>

                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><i class="fas fa-bed"></i> <span></span>Accommodation</a>
                    <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                        <a class="dropdown-item" href="#">Hotels</a>
                        <a class="dropdown-item" href="#">B&B</a>
                    </div>
                </li>

                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><i class="fas fa-futbol"></i> <span></span>Sports</a>
                    <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                        <a class="dropdown-item" href="#">Stadium</a>
                        <a class="dropdown-item" href="#">Sport centres</a>
                        <a class="dropdown-item" href="#">Gyms</a>
                        <a class="dropdown-item" href="#">Swimming Pools</a>
                        <a class="dropdown-item" href="#">Running</a>
                    </div>
                </li>

                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><i class="fas fa-university"></i> <span></span>Culture</a>
                    <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                        <a class="dropdown-item" href="#">Art Galleries</a>
                        <a class="dropdown-item" href="#">Museums</a>
                        <a class="dropdown-item" href="#">Theatre</a>
                        <a class="dropdown-item" href="#">Faith</a>
                        <a class="dropdown-item" href="#">Sights</a>
                        <a class="dropdown-item" href="#">Castles</a>
                    </div>
                </li>

                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><i class="fas fa-briefcase"></i> <span></span>Professional</a>
                    <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                        <a class="dropdown-item" href="#">Banks</a>
                        <a class="dropdown-item" href="#">Universities</a>
                        <a class="dropdown-item" href="#">Solicitors</a>
                        <a class="dropdown-item" href="#">Schools</a>
                    </div>
                </li>

                <li class="nav-item"><a class="nav-link">
                    <div id="reportrange" class="pull-right">
                        <i class="far fa-calendar-alt"></i>&nbsp;<span></span><b class="caret"></b>
                    </div></a>
                </li>
            </ul>
            <form class="form-inline my-2 my-lg-0" id="search_form">
                <input class="form-control mr-sm-2" type="search" id="search_box" onkeyup="mySearch()" placeholder="Search ..." aria-label="Search">
                <button class="btn btn-light my-2 my-sm-0" type="submit" id="search_btn"><i class="fas fa-search"></i></button>
            </form>
            <a id="btn_add" href="#" onclick="$('#add').show();"><i class="fas fa-plus"></i></a>
        </div>
    </nav>
    <div id="clear"><a href="#" onclick="filterMap('clear');"><i class="fas fa-paint-brush"></i> clear filter</a></div>
</div>

<div id="map"></div>
<div id="info" class="box"></div>
<div id="add">
    <a href="#" style="margin-top:-1em;color:black;padding:0 3px;text-decoration:none;float:right;" onclick="$('#add').hide();"><i class="fas fa-times"></i></a><br>
    <button id="signin-button" onclick="handleSignInClick()">Sign in</button>
    <button id="signout-button" onclick="handleSignOutClick()">Sign out</button><BR><BR>
    <h4>Add Location</h4>
    <br>
    <form id="add_form">
        <div class="form-group row">
            <label for="location_name" class="col-4 col-form-label">Location name</label>
            <div class="col-8">
                <input id="location_name" name="location_name" class="form-control here" required="required" type="text">
            </div>
        </div>
        <div class="form-group row">
            <label for="cat" class="col-4 col-form-label">Category</label>
            <div class="col-8">
                <select id="cat" name="cat" class="custom-select" required="required">
                    <option></option>
                    <option>Accommodation</option>
                    <option>Culture</option>
                    <option>Dining</option>
                    <option>Entertainment</option>
                    <option>Professional</option>
                    <option>Sports</option>
                </select>
            </div>
        </div>
        <div class="form-group row">
            <label for="subcat" class="col-4 col-form-label">Subcategory</label>
            <div class="col-8">
                <select id="subcat" name="subcat" class="custom-select" required="required">
                    <option></option>
                </select>
            </div>
        </div>
        <div class="form-group row">
            <label for="website" class="col-4 col-form-label">Website</label>
            <div class="col-8">
                <input id="website" name="website" aria-describedby="websiteHelpBlock" required="required" class="form-control here" type="url">
                <span id="websiteHelpBlock" class="form-text text-muted">e.g. https://www.yourfavoriteplace.com</span>
            </div>
        </div>
        <div class="form-group row">
            <label for="facebook" class="col-4 col-form-label">Facebook</label>
            <div class="col-8">
                <input id="facebook" name="facebook" aria-describedby="facebookHelpBlock" required="required" class="form-control here" type="url">
                <span id="facebookHelpBlock" class="form-text text-muted">e.g. https://www.facebook.com/yourfavoriteplace</span>
            </div>
        </div>
        <div class="form-group row">
            <div class="offset-4 col-8" style="text-align: right;">
                <button name="submit" type="submit" class="btn btn-primary">Submit</button>
            </div>
        </div>
    </form>
</div>

<div id="rating">
    <a href="#" style="margin-top:-1em;color:black;padding:0 3px;text-decoration:none;float:right;" onclick="$('#rating').hide();"><i class="fas fa-times"></i></a><br>
    <button id="signin-button2" onclick="handleSignInClick()">Sign in</button>
    <button id="signout-button2" onclick="handleSignOutClick()">Sign out</button><BR><BR>
    <h4>Rate Location</h4>
    <br>
    <form id="change_rating" class="form-horizontal">
        <table>
        <tr>
            <td><b>Location name</b></td><td><span id="rating_name"></span></td>
        </tr>
        <tr>
            <td><b>Rating</b></td>
            <td>
                <label class="radio-inline">
                    <input type="radio" name="rating_score" value="1">
                    <i class="fas fa-star"></i>
                </label>
                <label class="radio-inline">
                    <input type="radio" name="rating_score" value="2">
                    <i class="fas fa-star"></i><i class="fas fa-star"></i>
                </label>
                <label class="radio-inline">
                    <input type="radio" name="rating_score" value="3">
                    <i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i>
                </label>
            </td>
        </tr>
        <tr>
            <td>&nbsp;</td>
            <td>
                <div class="offset-4 col-8">
                    <button name="submit" type="submit" class="btn btn-primary">Submit</button>
                </div>
            </td>
        </tr>
    </table>
    </form>
</div>

<script>
    var valueRangeBody;
    $(document).ready(function () {

        $("#add_form").submit(function (a) {
            a.preventDefault();
            if(gapi.auth2.getAuthInstance().isSignedIn.get()){
                var formula = '=IFERROR(IF(ISBLANK(INDIRECT("R[0]C[-1]", false)),"",getGeo(SUBSTITUTE(INDIRECT("R[0]C[-3]", false),"\'","")&", Aberdeen, UK")),"")';
                var rating = '=iferror(round(AVERAGEIF(Sheet2!$A:$A,INDIRECT("R[0]C[-4]", false),Sheet2!$F:$F),0),0)';
                valueRangeBody = {
                    "values": [
                        [$('#cat').val(),$('#subcat').val(),$('#location_name').val(),$('#website').val(),$('#facebook').val(),formula,rating]
                    ]
                };
                makeAPIcall(1);
                alert("Categories successfully updated!");
                $('#add_form').each(function(){
                    this.reset();
                });
                $('#subcat').val("");
                $('#add').toggle();

            } else {
                alert("You need to sign in first.");
            }
        });

        $("#change_rating").submit(function(b) {
            b.preventDefault();
            if(gapi.auth2.getAuthInstance().isSignedIn.get()){
                var name = $('#rating_name').text();
                var rating = $('input[name=rating_score]:checked', '#change_rating').val();
                var mail = gapi.auth2.getAuthInstance().currentUser.get().w3.U3;
                var timestamp = moment();
                var weight= "=1/arrayformula(COUNTIF(A:A&C:C,INDIRECT(\"R[0]C[-4]\", false)&INDIRECT(\"R[0]C[-2]\", false)))";
                var new_rating = "=if(arrayformula(COUNTIF(A:A&C:C,INDIRECT(\"R[0]C[-5]\",false)&INDIRECT(\"R[0]C[-3]\",false)))>1,AVERAGEIFS(B:B,A:A,INDIRECT(\"R[0]C[-5]\",false),C:C,INDIRECT(\"R[0]C[-3]\",false)),INDIRECT(\"R[0]C[-4]\",false))";

                valueRangeBody = {
                    "values": [
                        [name,rating,mail,timestamp,weight,new_rating]
                    ]
                };
                makeAPIcall(2);
                alert("Rating successfully added!");
                $('#change_rating').each(function(){
                    this.reset();
                });
                $('#rating').toggle();

            } else {
                alert("You need to sign in first.");
            }
        });

    });


    function makeAPIcall(sheet) {

        var params = {
            // The ID of the spreadsheet to update.
            spreadsheetId: '1laOX2_2aeSDz3H8lP7U8W_ohgeK39Ye1J3X-Q-_hsDU',

            // The A1 notation of a range to search for a logical table of data.
            // Values will be appended after the last row of the table.
            range: 'Sheet' + sheet +'!A2:F2',

            // How the input data should be interpreted.
            valueInputOption: 'USER_ENTERED',

            // How the input data should be inserted.
            insertDataOption: 'INSERT_ROWS'
        };

        var request = gapi.client.sheets.spreadsheets.values.append(params, valueRangeBody);
        request.then(function(response) {

            console.log(response);
            // console.log(response.result.tableRange);
        }, function(reason) {
            console.error('error: ' + reason.result.error.message);
        });
    }

    function initClient() {
        var API_KEY = 'AIzaSyApTvTwhzrDL5KuyNJAukTGCkDE6hOudVI';
        var CLIENT_ID = '182461052315-elq806k272bg9a09jhqanv8neujp0poj.apps.googleusercontent.com';

        // TODO: Authorize using one of the following scopes:
        //   'https://www.googleapis.com/auth/drive'
        //   'https://www.googleapis.com/auth/drive.file'
        //   'https://www.googleapis.com/auth/spreadsheets'
        var SCOPE = 'https://www.googleapis.com/auth/spreadsheets';

        gapi.client.init({
            'apiKey': API_KEY,
            'clientId': CLIENT_ID,
            'scope': SCOPE,
            'discoveryDocs': ['https://sheets.googleapis.com/$discovery/rest?version=v4']
        }).then(function() {
            gapi.auth2.getAuthInstance().isSignedIn.listen(updateSignInStatus);
            updateSignInStatus(gapi.auth2.getAuthInstance().isSignedIn.get());
        });
    }

    function handleClientLoad() {
        gapi.load('client:auth2', initClient);
    }

    function updateSignInStatus(isSignedIn) {
        if (isSignedIn) {
            //makeApiCall();
            //console.log(gapi.auth2.getAuthInstance().currentUser.get().w3.U3);
            console.log("Signed in");
        }
    }

    function handleSignInClick(event) {
        gapi.auth2.getAuthInstance().signIn();
    }

    function handleSignOutClick(event) {
        gapi.auth2.getAuthInstance().signOut();
    }
</script>
<script async defer src="https://apis.google.com/js/api.js"
        onload="this.onload=function(){};handleClientLoad()"
        onreadystatechange="if (this.readyState === 'complete') this.onload()">
</script>
</body>
</html>